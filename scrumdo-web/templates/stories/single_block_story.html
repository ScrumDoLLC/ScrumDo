{% load i18n %}
{% load comments_tag %}
{% load threadedcommentstags %}
{% load projects_tags %}
{% load story_tags %}
{% load tasks_tags %}
{% load avatar_tags %}
{% load markup %}

<li class="story_block gripper_{% ifequal story.status 1 %}todo{% endifequal %}{% ifequal story.status 3 %}reviewing{% endifequal %}{% ifequal story.status 2 %}doing{% endifequal %}{% ifequal story.status 4 %}done{% endifequal %}" story_id="{{story.id}}" id="story_{{story.id}}" rank="{{ story.rank }}" >
  <div class="block_story_body">
  <div class="pointsBox">{{ story|show_points }}</div>
  <div class="todoButtons todoButtons_block" id="todoButtons_{{story.id}}">
    {% with "block" as return_type %}
      {% include "stories/todobuttons.html" %}
    {% endwith %}
  </div>

  <span class="storyIcons">
    <a class="hoverDetails" onclick="jQuery.facebox({ ajax: '/projects/project/{{story.project.slug}}/story/{{story.id}}/pretty'}, 'pretty_print'); return false;" href="/projects/project/{{story.project.slug}}/story/{{story.id}}/pretty"><img title="Quick View" src="{{STATIC_URL}}pinax/images/silk/icons/magnifier.png" /></a>

    
    {% canwrite project %}
        <a story_id="{{ story.id }}" class="moveIterationIcon"  href="#"><img title="Move To Another Iteration" src="{{ STATIC_URL }}pinax/images/silk/icons/page_white_go.png" /></a>
        <a onclick="setupAutoClose('#todoButtons_{{story.id}}'); jQuery('#todoButtons_{{story.id}}').show();  return false;" href="#"><img title="Set Status" src="{{ STATIC_URL }}pinax/images/silk/icons/tag_red.png" /></a>
        <a onclick="openOverlay( '/projects/project/{{ story.project.slug }}/story/{{ story.id }}?return_type=block' ); return false;" href="/project/{{ story.project.slug }}/story/{{ story.id }}?return_type=block"><img title="Edit Story" src="{{ STATIC_URL }}pinax/images/silk/icons/pencil.png" /></a>
        {% include "stories/single_extra_icons.html" %}
    {% endcanwrite %}  
    </span>


    
  <h1 class="formatted_story_text"><span class="story_number" style="color:#555555;">#{{story.local_id}}</span>
	 {{ story.summary|markdown|urlify2|link_stories:story.project|safe }}</h1>

  <span class="formatted_story_text story_detail">
  {{ story.detail|markdown|urlify2|link_stories:story.project|safe }}
  </span>
  
    


<div class="story_footer">
  {% if story.project.use_assignee and story.assignee %}
      {% avatar story.assignee 20 %} <b>{{story.assignee}}</b> -
  {% endif %}


  {% if story.project.use_tasks %}
    <a onClick="showTasksForStory({{story.id}}); return false;" href="#">{% task_counts story %} Tasks</a> -
  {% endif %}
    {% get_comment_count for story as comment_count %}
    <a onClick="showCommentsForStory({{story.id}}); return false;" href="#">{{comment_count}} Comment{{comment_count|pluralize}}</a>

	{% if story.category %}
 	  <div class="tagsBox">{% silk "folder" %} {{story.category}}</div>
	{% endif %}

	{% if not iteration %}
	  {# If there is an iteration defined, we're on a page about an iteration, so no need to display it. #}
      <div class="tagsBox iterationTagsBox">{% silk "page_white" %} 
	  <a href="{% url iteration project.slug story.iteration.id %}">{{story.iteration.name}}</a>
	  </div>

	{% endif %}

  {% if not epic %}
    {# If there is an epic defined, we're likely rendering within that epic, so no need to display the epic info #}
    {% if story.epic %}
      <div class="tagsBox">{% silk "chart_organisation" %} <a href="{% url epics project.slug %}" title="{{story.epic.full_name|escape}}">{{story.epic.short_name}}</a></div>
    {% endif %}
  {% endif %}

  {% for tag in story.story_tags_full %}
     <div class="tagsBox">{% silk "tag_blue" %}<a href="{% url tag_detail project.slug tag.name %}">{{ tag.name }}</a></div>
  {% endfor %}


  {% for link in story.external_links.all %}
   {% if link.external_url %}
     <div class="tagsBox">{% silk "link" %} <a href="{{ link.external_url }}">{{ link.extra_slug }}</a></div>
   {% endif %}
  {% endfor %}



  
  {% include "stories/single_extra.html" %}

</div>

<div id="story_comments_{{story.id}}" style="display:none"></div>


{% if story.project.use_tasks %}
  {% include "stories/tasks_section.html" %}
{% endif %}

</div>



</li>  
